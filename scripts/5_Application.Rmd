---
title: "Application to unlabeled data"
author: "Cornelius Erfort"
date: "8/5/2021"
output: 
  pdf_document:
    dev: cairo_pdf
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, tidy.opts=list(width.cutoff = 80), tidy = T, python.reticulate = F)
knitr::opts_knit$set(root.dir = dirname(getwd()))
```

# Summary

We predict issue labels for all unlabeled German press releases and calculate the share of press releases dedicated to each issue area for each quarter.

# Setting up

This script requires the files which are not included on GitHub.

At the end of this script, the file "issue_agendas.RData" is saved. It contains quarterly estimates for the share of press releases for each issue and party.

## Loading packages

```{r packages, message=FALSE, warning=FALSE, results='hide'}
start_time <- Sys.time()

packages <- c(
  "quanteda", "quanteda.textmodels", "dplyr", "caret", "randomForest", "tm", "rmarkdown", "plyr", "readr", "ggplot2", "stringr", "formatR", "readstata13", "lubridate", "reticulate", "doMC", "glmnet", "kableExtra", "stargazer", "extrafont", "ggrepel")

lapply(packages[!(packages %in% rownames(installed.packages()))], install.packages)

if(!("quanteda.classifiers" %in% rownames(installed.packages()))) {
  remotes::install_github("quanteda/quanteda.classifiers")
} 

invisible(lapply(c(packages, "quanteda.classifiers"), require, character.only = T))

loadfonts()
loadfonts(device = "pdf")
theme_update(text = element_text(family = "LM Roman 10")) # Set font family for ggplot

if(!dir.exists("supervised-files")) dir.create("supervised-files")

source("scripts/functions.R")

```

# Classification of unlabeled data

## Using the fine-tuned Transformers

We trained the models using a set of 2,612 labeled documents. In order to obtain aggregated measures of issue attention, we predict the issue categories of all ? labeled and unlabeled press releases in our sample.


```{r unlabeled}
# Load the predicted labels
alldocs <- read_csv("transfer-files/alldocs-pred.csv", col_names = F)
names(alldocs) <- c("label",  "id")

# Translate labels back into CAP issues
labels <- read_csv("transfer-files/bert-pred.csv", col_names = F)[, 2:3] %>% unique
names(labels) <- c("issue", "label")
labels$issue[labels$issue == 191] <- 19.1
labels$issue[labels$issue == 192] <- 19.2
labels$issue <- factor(labels$issue, levels = c(1:10, 12:18, 19.1, 19.2, 20, 23, 98, 99))
alldocs <- merge(alldocs, labels, by = "label") %>% select(-c(label))

# Load and merge unlabeled data
load("data/all/germany.RData")
nrow(germany)
alldocs <- merge(germany, alldocs, by = "id")
nrow(germany)

# Table of predicted issues 
table(alldocs$issue) %>% as.data.frame() %>% 
  dplyr::rename(issue = Var1, n = Freq) %>% t() %>% kbl(booktabs = T) %>% 
  kable_styling(latex_options = "scale_down")

table(alldocs$issue) / nrow(alldocs)

# Clean party names
party_names <- data.frame(party = c("90gruene_fraktion",
                                    "afd_bundesverband", "afd_fraktion",
                                    "fdp_bundesverband", "fdp_fraktion", "linke_fraktion",
                                    "spd_fraktion", "union_fraktion"),
                          party_name = c("B'90/Die GrÃ¼nen", 
                                         "AfD", "AfD", 
                                         "FDP", "FDP", "DIE LINKE", 
                                         "SPD", "CDU/CSU"))
alldocs <- merge(alldocs, party_names, by = "party")
nrow(alldocs)


# Tables for samples of press releases
# Environment
sample7 <- select(alldocs, c("party_name", "date", "header", "issue")) %>% filter(issue == 7)
(sample7 <- sample7[sample(1:nrow(sample7), 10), ])

latex_out <- capture.output(sample7 %>% dplyr::rename(party = party_name, title = header) %>%
  stargazer(type = "latex", summary = F, rownames = F, 
            title = "Sample of press releases classified as category 7 - Environment", label = "tab:7-document-samples"))

latex_out <- capture.output(latex_out %>% str_replace_all( "tabular", "tabularx")  %>% str_replace_all("\\@\\{\\\\extracolsep\\{5pt\\}\\} ccc", "\\\\textwidth\\}\\{stX") %>% cat(sep = "\n"), file = "tables/7-document-samples.tex")

# Immigration
sample9 <- select(alldocs, c("party_name", "date", "header", "issue")) %>% filter(issue == 9)
(sample9 <- sample9[sample(1:nrow(sample9), 10), ])

latex_out <- capture.output(sample9 %>% dplyr::rename(party = party_name, title = header) %>%
  stargazer(type = "latex", summary = F, rownames = F, 
            title = "Sample of press releases classified as category 9 - Immigration", label = "tab:9-document-samples"))

latex_out <- capture.output(latex_out %>% str_replace_all( "tabular", "tabularx")  %>% str_replace_all("\\@\\{\\\\extracolsep\\{5pt\\}\\} ccc", "\\\\textwidth\\}\\{stX") %>% cat(sep = "\n"), file = "tables/9-document-samples.tex")
```


## Aggregation of the issues categories over time and party

To measure parties' evolving issue agendas, we aggregate the category counts over time.

```{r aggregation}

# Create dataframe with only necessary vars
issue_agendas <- alldocs %>% select(c(date, issue, party_name)) %>% dplyr::rename(party = party_name)

# Make date quarterly
issue_agendas$date <- as.character(issue_agendas$date) %>% substr(1, 8) %>% str_c("15") %>% str_replace_all(c("-01-" = "-02-", "-03-" = "-02-", "-04-" = "-05-", "-06-" = "-05-", "-07-" = "-08-", "-09-" = "-08-", "-10-" = "-11-", "-12-" = "-11-")) %>%  ymd()

# Add variable for counting
issue_agendas$freq <- 1

# Aggregate by party, date and issue
issue_agendas <- aggregate(freq ~ party + date + issue, issue_agendas, sum)

# Add observations with zero documents
for (thisparty in unique(issue_agendas$party)) {
  for(thisdate in unique(issue_agendas$date[issue_agendas$party == thisparty])) {
    for(thisissue in unique(issue_agendas$issue)) {
      if(nrow(issue_agendas[issue_agendas$party == thisparty & issue_agendas$date == thisdate & issue_agendas$issue == thisissue, ]) == 0 & nrow(issue_agendas[issue_agendas$party == thisparty & issue_agendas$date == thisdate, ]) != 0) {
        issue_agendas <- data.frame(
          party = thisparty,date = thisdate, issue = thisissue, freq = 0
          ) %>% rbind.fill(issue_agendas)
}}}}

# Add var for total press releases per party and month
issue_agendas$party_sum <- ave(issue_agendas$freq, issue_agendas$date, issue_agendas$party, FUN = sum)

issue_agendas$attention <- issue_agendas$freq / issue_agendas$party_sum

# Add issue descriptions
issue_categories <- 
  data.frame(issue = c(1:10, 12:18, 191:192, 20, 23, 98, 99), 
             issue_descr = c("Macroeconomics", "Civil Rights", "Health", "Agriculture", "Labor", "Education", 
              "Environment", "Energy", "Immigration", "Transportation", "Law and Crime", 
              "Social Welfare", "Housing", "Domestic Commerce", "Defense", "Technology", 
              "Foreign Trade", "International Affairs", "European Integration", "Government Operations", "Culture", "Non-thematic", "Other"))

issue_agendas <- merge(issue_agendas, issue_categories, by = "issue") %>% select(-c(freq))

issue_agendas$date <- issue_agendas$date %>% as.Date(origin = "1970-01-01")

save(issue_agendas, file = "data/issue_agendas.RData")


```

# Visualize issue agendas

```{r viz}
if(!dir.exists("plots")) dir.create("plots")

## Facet (all parties separate)
# Environment and Energy
plot_issue_agenda(issue_agendas, 7,  unique(issue_agendas$party), T) 
# Immigration
plot_issue_agenda(issue_agendas, 9,  unique(issue_agendas$party), T) 


# All parties in one plot
plot_issue_agenda(issue_agendas, unique(issue_agendas$party), T)



# Show spike in attention to immigration
spec_att <- issue_agendas %>% filter(issue %in% c(7, 9)) # & party != "AfD")
spec_att$time <- ""
spec_att$time[spec_att$date >= ymd("2015-01-01") & spec_att$date <= ymd("2015-12-31") & spec_att$issue == 9] <- "2015" 
spec_att$time[spec_att$date >= ymd("2014-01-01") & spec_att$date <= ymd("2014-12-31") & spec_att$issue == 9] <- "2014"
spec_att$time[spec_att$date >= ymd("2018-01-01") & spec_att$date <= ymd("2018-12-31") & spec_att$issue == 7] <- "2018" 
spec_att$time[spec_att$date >= ymd("2017-01-01") & spec_att$date <= ymd("2017-12-31") & spec_att$issue == 7] <- "2017" 
# spec_att$time[spec_att$date >= ymd("2011-01-01") & spec_att$date <= ymd("2011-12-31") & spec_att$issue == 7] <- "2011" 
spec_att <- filter(spec_att, time != "")  %>% aggregate(attention ~ party + time + issue, ., mean)
spec_att$issue[spec_att$issue == 7] <- "7 - Environment"
spec_att$issue[spec_att$issue == "9"] <- "9 - Immigration"
filename <- "all-parties_facet_supervised-change"
# setwd("/Users/cornelius/Desktop/SCRIPTS/GitHub/scripts-issue-agendas/")
ggplot(spec_att, aes(x = time, y = attention)) +
  theme(text = element_text(size = 14)) +
  ylab("Share of press releases per year") +
  geom_point(aes(color = party, shape = party)) +
  geom_line(aes(group = party, color = party), lty = 2, alpha = .5) +
  geom_text_repel(data = spec_att[spec_att$time %in% c("2017", "2014"), ], aes(x = spec_att[spec_att$time %in% c("2017", "2014"), "time"], y = spec_att[spec_att$time %in% c("2017", "2014"), "attention"]), label = round(spec_att[spec_att$time %in% c("2017", "2014"), "attention"], 2), hjust = "left", colour = "dark grey", family = "LM Roman 10", box.padding = .4, size = 4, segment.size = .25,  min.segment.length = .1, point.padding = .5, max.overlaps = 100, nudge_x = -.25) +
  geom_text_repel(data = spec_att[!(spec_att$time %in% c("2017", "2014")), ], aes(x = spec_att[!(spec_att$time %in% c("2017", "2014")), "time"], y = spec_att[!(spec_att$time %in% c("2017", "2014")), "attention"]), label = round(spec_att[!(spec_att$time %in% c("2017", "2014")), "attention"], 2), hjust = "right", colour = "dark grey", family = "LM Roman 10", box.padding = .4, size = 4, segment.size = .25, min.segment.length = .1, point.padding = .5, max.overlaps = 100, nudge_x = .25) +
  scale_color_manual(values = c("blue", "green", "black", "purple", "yellow", "red")) + #"blue", 
  facet_grid(~ issue, scales = "free_x")
  
  
  ggsave(str_c("plots/", filename, ".pdf"), device = cairo_pdf, width = 5*2^.5, height = 5)
  
  ggsave(str_c("plots/", filename, ".png"), width = 5*2^.5, height = 5)

```



```{r script_eval}
# Time needed to run script
print(Sys.time() - start_time) 

