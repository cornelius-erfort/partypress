---
title: "Visualizing issue agendas"
author: "Cornelius Erfort"
date: "6/3/2021"
output: 
  pdf_document:
    dev: cairo_pdf
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, tidy.opts=list(width.cutoff = 80), tidy = T, python.reticulate = F)
knitr::opts_knit$set(root.dir = dirname(getwd()))

```

# Setting up

## Loading packages

This script is based mainly on the functions of the quanteda package. For the cross-validation of the textmodels, quanteda.classifiers has to be loaded from GitHub.

```{r packages, message=FALSE, warning=FALSE, results='hide'}
start_time <- Sys.time()

packages <- c(
  "quanteda", "quanteda.textplots", "quanteda.textmodels", "quanteda.textstats", "dplyr", "tm", "rmarkdown", "plyr", "readr", "ggplot2", "stringr", "formatR", "readstata13", "lubridate", "glmnet", "kableExtra", "stargazer", "tidyr", "extrafont", "ggrepel")

lapply(packages[!(packages %in% rownames(installed.packages()))], install.packages)

invisible(lapply(packages, require, character.only = T))

theme_update(text = element_text(family = "LM Roman 10")) # Set font family for ggplot

loadfonts()
loadfonts(device = "pdf")
source("scripts/functions.R")

```



```{r data}

load("supervised-files/issue_agendas_supervised.RData")
issue_agendas_supervised$date <- as.Date(issue_agendas_supervised$date, origin = "1970-01-01")
load("readme-files/issue_agendas_readme.RData")
issue_agendas_readme$date <- as.Date(issue_agendas_readme$date, origin = "1970-01-01")



```



## Plotting issue attention: Examples

In this section we plot the share of press releases (issue attention) of the total amount of press releases per quarter for each party. We also include a Loess-smoothed curve.

We focus on the topics "7 - Environment and Energy" and "9 - Immigration".

The last plots show all parties' issue attention at once.

```{r plots, out.width = "80%"}

if(!dir.exists("plots")) dir.create("plots")
if(!dir.exists("plots/pdf")) dir.create("plots/pdf")
if(!dir.exists("plots/png")) dir.create("plots/png")

# Supervised
## Plot for every party and two issues
for(this_party in unique(issue_agendas_supervised$party)) {
  # Environment and Energy
  plot_issue_agenda(issue_agendas_supervised, 7,  this_party, F) 
  # Immigration
  plot_issue_agenda(issue_agendas_supervised, 9,  this_party, F) 
}

## Facet (all parties separate)
# Environment and Energy
plot_issue_agenda(issue_agendas_supervised, 7,  unique(issue_agendas_supervised$party), T) 
# Immigration
plot_issue_agenda(issue_agendas_supervised, 9,  unique(issue_agendas_supervised$party), T) 

## All parties in one plot
# Environment and Energy
plot_issue_agenda(issue_agendas_supervised, 7,  unique(issue_agendas_supervised$party), F) 
# Immigration
plot_issue_agenda(issue_agendas_supervised, 9,  unique(issue_agendas_supervised$party), F) 



# Show spike in attention to immigration
spec_att <- issue_agendas_supervised %>% filter(issue_r1 %in% c(7, 9)) # & party != "AfD")
spec_att$time <- ""
spec_att$time[spec_att$date >= ymd("2015-01-01") & spec_att$date <= ymd("2015-12-31") & spec_att$issue_r1 == 9] <- "2015" 
spec_att$time[spec_att$date >= ymd("2014-01-01") & spec_att$date <= ymd("2014-12-31") & spec_att$issue_r1 == 9] <- "2014"
spec_att$time[spec_att$date >= ymd("2013-01-01") & spec_att$date <= ymd("2013-12-31") & spec_att$issue_r1 == 7] <- "2013" 
spec_att$time[spec_att$date >= ymd("2012-01-01") & spec_att$date <= ymd("2012-12-31") & spec_att$issue_r1 == 7] <- "2012" 
# spec_att$time[spec_att$date >= ymd("2011-01-01") & spec_att$date <= ymd("2011-12-31") & spec_att$issue_r1 == 7] <- "2011" 
spec_att <- filter(spec_att, time != "")  %>% aggregate(attention ~ party + time + issue_r1, ., mean)
spec_att$issue_r1[spec_att$issue_r1 == 7] <- "7 - Environment and Energy"
spec_att$issue_r1[spec_att$issue_r1 == "9"] <- "9 - Immigration"

filename <- "all-parties_facet_supervised-change"
setwd("/Users/cornelius/Desktop/SCRIPTS/GitHub/scripts-issue-agendas/")
ggplot(spec_att, aes(x = time, y = attention)) +
  theme(text = element_text(size = 14)) +
  ylab("Share of press releases per year") +
  geom_point(aes(color = party, shape = party)) +
  geom_line(aes(group = party, color = party), lty = 2, alpha = .5) +
  geom_text_repel(data = spec_att[spec_att$time %in% c("2012", "2014"), ], aes(x = spec_att[spec_att$time %in% c("2012", "2014"), "time"], y = spec_att[spec_att$time %in% c("2012", "2014"), "attention"]), label = round(spec_att[spec_att$time %in% c("2012", "2014"), "attention"], 2), hjust = "left", colour = "dark grey", family = "LM Roman 10", box.padding = .4, size = 4, segment.size = .25,  min.segment.length = .1, point.padding = .5, max.overlaps = 100, nudge_x = -.25) +
  geom_text_repel(data = spec_att[!(spec_att$time %in% c("2012", "2014")), ], aes(x = spec_att[!(spec_att$time %in% c("2012", "2014")), "time"], y = spec_att[!(spec_att$time %in% c("2012", "2014")), "attention"]), label = round(spec_att[!(spec_att$time %in% c("2012", "2014")), "attention"], 2), hjust = "right", colour = "dark grey", family = "LM Roman 10", box.padding = .4, size = 4, segment.size = .25, min.segment.length = .1, point.padding = .5, max.overlaps = 100, nudge_x = .25) +
  scale_color_manual(values = c("blue", "green", "black", "purple", "yellow", "red")) + #"blue", 
  facet_grid(~ issue_r1, scales = "free_x") +
  ggsave(str_c("plots/", filename, ".pdf"), device = cairo_pdf, width = 5*2^.5, height = 5) +
  ggsave(str_c("plots/", filename, ".png"), width = 5*2^.5, height = 5)


# Readme
## Plot for every party and two issues
for(this_party in unique(issue_agendas_readme$party)) {
  # Environment and Energy
  plot_issue_agenda(issue_agendas_readme, 7,  this_party, F) 
  # Immigration
  plot_issue_agenda(issue_agendas_readme, 9,  this_party, F) 
}

## Facet (all parties separate)
# Environment and Energy
plot_issue_agenda(issue_agendas_readme, 7,  unique(issue_agendas_readme$party), T) 
# Immigration
plot_issue_agenda(issue_agendas_readme, 9,  unique(issue_agendas_readme$party), T) 

## All parties in one plot
# Environment and Energy
plot_issue_agenda(issue_agendas_readme, 7,  unique(issue_agendas_readme$party), F) 
# Immigration
plot_issue_agenda(issue_agendas_readme, 9,  unique(issue_agendas_readme$party), F) 


```


The plots have a good face validity showing increased attention to immigration around the so-called refugee crisis as well as peaks in attention to the environment after Fukushima in 2011 and more recently.

As expected, the Greens regularly produce the highest share of press releases regarding the environment. For immigration, the AfD has the highest share.




# Compare readme2 to aggregated supervised

```{r agg_eval_compare, out.width = "80%"}
# Comparing aggregate predictions
load("supervised-files/agg_eval.RData")
agg_eval_supervised <- agg_eval
load("readme-files/agg_eval.RData")
agg_eval_readme <- agg_eval
agg_eval_supervised$method <- "supervised"
agg_eval_readme$method <- "readme"

agg_eval <- rbind(agg_eval_supervised, agg_eval_readme)

# MSE of means from five-folds before CV
agg_eval %>% group_by(method) %>% dplyr::summarise(SE = (truth-predicted)^2) %>% dplyr::summarise(M = across(SE, mean))

agg_eval <- agg_eval %>% dplyr::group_by(method, issue_r1) %>% 
  dplyr::summarise(predicted = mean (predicted),
            truth = mean(truth)) %>% as.data.frame()

agg_eval$method <- factor(agg_eval$method, levels = c("supervised", "readme"))

# MSE of means from CV
agg_eval %>% group_by(method) %>% dplyr::summarise(SE = (truth-predicted)^2) %>% dplyr::summarise(M = across(SE, mean))

ggplot(agg_eval, aes(x = truth, y = predicted)) +
  geom_line(aes(group = issue_r1), col = 'gray') +
  geom_abline(slope = 1, color = "light grey") +
  geom_point(aes(shape = method, color = method)) +
  ylim(c(0, .15)) + xlim(c(0, .15)) +
  guides(color = guide_legend(ncol = 1)) +
  labs(color = "Method", shape = "Method",
       caption = "The plot shows the mean values from a five-fold cross-validation.") +
  theme(legend.position = "right", 
        aspect.ratio = 1, 
        text = element_text(family = "LM Roman 10", size = 12), 
        legend.text = element_text(size = 12),
        legend.key.size =  unit(1.1,"line")) +
  ggsave("plots/agg_eval_compare.pdf", 
         device = cairo_pdf, width = 4*2^.5, height = 4) +
  ggsave("plots/agg_eval_compare.png", 
         width = 4*2^.5, height = 4)

# Plotting aggregate evaluation in one plot
ggplot(agg_eval, aes(x = truth, y = predicted)) +
  geom_abline(slope = 1, color = "light grey") +
  geom_text_repel(label = agg_eval$issue_r1 %>%
              str_extract("[:digit:]{1,2}(\\.[:digit:])?"),
              box.padding = .4,
            color = "dark grey", size = 2, family = "LM Roman 10", 
            segment.size = .25, 
            min.segment.length = .1,
            point.padding = .15, max.overlaps = 100) +
    geom_point(shape = "o", aes(color = issue_r1)) +
  ylim(c(0, .15)) + xlim(c(0, .15)) +
  guides(color = guide_legend(ncol = 1)) +
  labs(color = "Issue category", 
       caption = "The plot shows the mean values from a five-fold cross-validation.") +
  theme(legend.position = "right",
        aspect.ratio = 1, 
        text = element_text(size = 7),
        legend.key.size =  unit(.5,"line"),
        legend.text = element_text(size = 5)) +
  facet_wrap(~ method) +
  ggsave("plots/agg_eval_compare_facet.pdf", 
         device = cairo_pdf, width = 3*2^.5, height = 3) +
  ggsave("plots/agg_eval_compare_facet.png",  
         width = 3*2^.5, height = 3)
```

```{r issue_agendas_compare, out.width = "80%"}
# Plotting supervised and readme2
issue_agendas <- merge(issue_agendas_supervised %>% dplyr::rename(attention_supervised = attention) %>% select(-c(issue_r1_descr)), issue_agendas_readme %>% dplyr::rename(attention_readme = attention), by = c("party", "issue_r1", "date"), all = T)

issue_agendas %>% select(starts_with("att")) %>% cor() # r ~ .826

issue_agendas <- pivot_longer(issue_agendas, cols = starts_with("att"), values_to = "attention", names_to = "method")
issue_agendas$method <- issue_agendas$method %>% str_remove("attention_")
issue_agendas$method <- factor(issue_agendas$method, levels = c("supervised", "readme"))


# 7 Environment and Energy
plot_issue_agenda(issue_agendas, 7,  unique(issue_agendas$party), T)
plot_issue_agenda(issue_agendas, 7,  unique(issue_agendas$party), T)

# 9 Immigration
plot_issue_agenda(issue_agendas, 9,  unique(issue_agendas$party), T)
plot_issue_agenda(issue_agendas, 9,  unique(issue_agendas$party), T)

```



```{r keyness_tables, out.width = "80%"}
# Key words/features for classified topics
load("supervised-files/train-test/dfmat.RData")
tm_naivebayes <- textmodel_nb(dfmat, dfmat$issue_r1, distribution = "multinomial")

tm_naivebayes$param[1, ]

load("supervised-files/dfmat_all.RData")
textstat_keyness(dfmat_all, dfmat_all$issue_r1 == 7)[1:20]
latex_out <- capture.output(stargazer(textstat_keyness(dfmat_all, dfmat_all$issue_r1 == 7)[1:20] %>% as.data.frame(), summary = F,
            title = "Key features for documents classified as 7 - Environment and Energy", 
            label = "tab:textstat_keyness_7", 
  out = "tables/textstat_keyness_7-environment-and-energy_supervised.tex"))

textstat_keyness(dfmat_all, dfmat_all$issue_r1 == 9)[1:20]
latex_out <- capture.output(stargazer(textstat_keyness(dfmat_all, dfmat_all$issue_r1 == 9)[1:20] %>% as.data.frame(), summary = F,
            title = "Key features for documents classified as 9 - Immigration", 
            label = "tab:textstat_keyness_9", 
  out = "tables/textstat_keyness_9-immigration.tex"))


```